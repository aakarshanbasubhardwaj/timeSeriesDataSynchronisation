<!DOCTYPE html>
<html lang="en">
    <head> 
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Time Series Data Synchronization</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="config.js"></script>

        <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css" />

        <link
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <style>
        html, body {
            height: 100%;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Plus Jakarta Sans", sans-serif;
            background-color: #ffffff;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: hidden;
        }

        .dm-sans {
            font-family: "DM Sans", sans-serif;
        }

        .app-container {
            display: flex;
            height: 100vh;
            min-height: 0;
        }

        .main-content,
        .placeholder-content {
            width: 100%;
            height: 100%;
        }
        .placeholder-content {
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #7a7cff;
            font-family: "DM Sans", sans-serif;
            min-height: 400px;
            text-align: center;
        }
        .placeholder-content.visible {
            display: flex;
        }
        .main-content.hidden {
            display: none !important;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            height: 54px;
            background-color: #fff;
            border-bottom: 1px solid rgba(255, 249, 249, 0);
            padding: 0.7rem 1rem;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
        }

        .header h1 {
            font-size: 16px;
            font-weight: 800;
            color: #1e293b;
            line-height: 20px;
            letter-spacing: -0.39px;
        }

        .content-area {
            flex: 1;
            padding: 0.7rem;
            overflow-y: auto;
        }

        .content-container {
            max-width: 1835px;
            margin: 0 auto;
        }

        .upload-section {
            margin-bottom: 1rem;
        }

        .upload-title {
            font-size: 16px;
            font-weight: 700;
            color: #222;
            margin-bottom: 1rem;
            font-family: "DM Sans", sans-serif;
        }

        .upload-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .drop-zone {
            height: 215px;
            border: 2px dashed #3276e8;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            background-color: #e8ecff;
            position: relative;
        }

        .drop-zone.dragging {
            background-color: #d1d9ff;
        }

        .drop-zone input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .drop-zone p {
            font-size: 16px;
            color: #222;
            opacity: 0.5;
            font-family: "DM Sans", sans-serif;
        }

        .file-tags {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .file-tag {
            padding: 0.25rem 0.5rem;
            background-color: rgba(34, 34, 34, 0.1);
            border-radius: 6px;
            font-size: 12px;
            color: #222;
            font-family: "DM Sans", sans-serif;
        }

        .file-tag.outline {
            background-color: transparent;
            border: 1px solid rgba(34, 34, 34, 0.1);
        }

        .upload-progress {
            display: none;
            margin-bottom: 2rem;
        }

        .upload-progress.visible {
            display: block;
        }

        .progress-card {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background-color: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 731px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25),
                0 4px 4px 0 rgba(0, 0, 0, 0.25)
            ;
        }

        .progress-info {
            flex: 1;
        }

        .progress-info h3 {
            font-size: 14px;
            font-weight: 700;
            color: #222;
            font-family: "DM Sans", sans-serif;
        }

        .progress-info p {
            font-size: 14px;
            font-family: "DM Sans", sans-serif;
        }

        .progress-info .blue-text {
            color: #3276e8;
        }

        .progress-info .gray-text {
            color: rgba(20, 27, 52, 0.4);
        }

        .progress-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .progress-bar {
            width: 160px;
            height: 0.18rem;
            background-color: rgba(49, 67, 98, 0.1);
            border-radius: 2px;
            position: relative;
        }

        .progress-fill {
            height: 0.25rem;
            background-color: #3276e8;
            border-radius: 2px;
            transition: width 0.3s;
            width: 0%;
        }

        .remove-btn {
            opacity: 0.25;
            cursor: pointer;
            background: none;
            border: none;
            padding: 2px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .chart-container {
            background-color: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 24px;
            padding: 1rem;
            width: 100%;
            min-height: 900px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }

        .chart-area {
            position: relative;
            height: 400px;
            margin-bottom: 1rem;
            align-items: center;
            justify-content: center;
        }

        .file-visualization {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            gap: 2rem;
            height: 100%;
            /* max-height: 700px; */
            overflow-y: auto;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            background-color: #f8fafc;
            color: #64748b;
            font-size: 14px;
            font-family: "DM Sans", sans-serif;
        }
        #visualizationPlaceholder {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 100% !important;
            text-align: center !important;
            color: #64748b !important;
            font-size: 14px !important;
            font-family: "DM Sans", sans-serif !important;
        }

        .empty-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background-color: #f8fafc;
            color: #64748b;
            font-size: 14px;
            font-family: "DM Sans", sans-serif;
            flex: 1;
        }

        .chart-grid {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .grid-lines {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .grid-line {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .grid-label {
            font-size: 12px;
            color: #475569;
            width: 2.25rem;
            text-align: right;
        }

        .grid-line-stroke {
            flex: 1;
            height: 1px;
            background-color: #cbd5e1;
        }

        .chart-svg {
            position: absolute;
            left: 2rem;
            top: 1rem;
            width: calc(100% - 2rem);
            height: 250px;
        }

        .chart-tooltip {
            position: absolute;
            background-color: #1e293b;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 800;
            display: none;
        }

        .chart-tooltip.visible {
            display: block;
        }

        .tooltip-arrow {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .x-axis {
            position: absolute;
            bottom: 0;
            left: 2rem;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #475569;
        }

        .chart-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .chart-title-btn {
            padding: 0.4rem 1.2rem;
            transition: background 0.2s, color 0.2s;
            border: 1px solid #cbd5e1;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 700;
            color: #475569;
            background: #f1f5f9;
            white-space: nowrap;
        }

        .chart-badges {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 700;
        }

        .badge-green {
            background-color: #f0fdf4;
            color: #22c55e;
        }

        .badge-gray {
            background-color: #f8fafc;
            color: #475569;
        }

        .sync-btn,
        .download-btn {
            background-color: #7a7cff;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.75px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7a7cff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
        }

        .hidden {
            display: none !important;
        }

        .sync-btn.disabled,
        .download-btn.disabled {
            filter: blur(1px);
            opacity: 0.5;
            pointer-events: none;
        }

        @media (max-width: 1200px) {
            .content-container {
                max-width: 100%;
                padding: 0 1rem;
            }

            .header h1 {
                font-size: 24px;
                line-height: 32px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: center;
                padding: 1rem;
                gap: 1rem;
            }

            .main-content {
                width: 100%;
            }

            .header {
                height: auto;
                min-height: 80px;
                padding: 1rem;
            }

            .header h1 {
                font-size: 18px;
                line-height: 24px;
                text-align: center;
            }

            .content-area {
                padding: 1rem;
            }

            .charts-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .chart-container {
                min-height: 250px;
            }

            .progress-bar {
                width: 120px;
            }

            .drop-zone {
                height: 180px;
            }

            .file-tags {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .sidebar-icon {
                width: 2.5rem;
                height: 2.5rem;
            }

            .header {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 16px;
                line-height: 20px;
            }

            .content-area {
                padding: 0.75rem;
            }

            .chart-container {
                padding: 1rem;
                min-height: 220px;
            }

            .progress-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .progress-controls {
                width: 100%;
                justify-content: space-between;
            }

            .progress-bar {
                width: 200px;
            }

            .chart-footer {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .chart-controls {
                width: 100%;
                justify-content: space-between;
            }

            .drop-zone {
                height: 150px;
                padding: 1rem;
            }

            .drop-zone p {
                font-size: 14px;
                text-align: center;
            }
        }

        @media (min-width: 1400px) {
            .charts-section {
                gap: 3rem;
            }

            .chart-container {
                min-height: 300px;
            }
        }
        </style>
    </head>
    <body>
        <div class="app-container">
            <div class="main-content" id="mainContent">
                <div class="header">
                <h1>
                    A Sliding Window Dynamic Time Warping-Based Approach for Time Series Data Synchronization
                </h1>
                </div>

                <div class="content-area">
                    <div class="content-container">
                        <div class="upload-section">
                            <!-- <h2 class="upload-title">Upload file</h2> -->
                            <div class="upload-container">
                                <div class="drop-zone" id="dropZone">
                                    <input
                                        type="file"
                                        accept=".csv"
                                        id="fileInput"
                                        multiple
                                    />
                                    <svg
                                        width="30"
                                        height="30"
                                        viewBox="0 0 31 31"
                                        fill="none"
                                        xmlns="http://www.w3.org/2000/svg"
                                    >
                                        <path
                                            d="M16.7501 3H17.091C21.1675 3 23.2058 3 24.6213 3.99729C25.0268 4.28304 25.3869 4.62191 25.6905 5.00361C26.7501 6.33584 26.7501 8.2542 26.7501 12.0909V15.2727C26.7501 18.9767 26.7501 20.8287 26.164 22.3078C25.2216 24.6857 23.2287 26.5614 20.7022 27.4483C19.1306 28 17.1629 28 13.2274 28C10.9786 28 9.85414 28 8.95609 27.6848C7.51236 27.1779 6.37356 26.1061 5.83508 24.7473C5.50012 23.9021 5.50012 22.8438 5.50012 20.7273V15.5"
                                            stroke="#3276E8"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        />
                                        <path
                                            d="M26.7502 15.5C26.7502 17.8012 24.8848 19.6667 22.5836 19.6667C21.7513 19.6667 20.7702 19.5208 19.961 19.7377C19.2421 19.9303 18.6805 20.4919 18.4879 21.2108C18.2711 22.02 18.4169 23.0011 18.4169 23.8333C18.4169 26.1345 16.5514 28 14.2502 28"
                                            stroke="#3276E8"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        />
                                        <path
                                            d="M14.25 8L4.25 8M9.25 3V13"
                                            stroke="#3276E8"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                        />
                                    </svg>
                                    <p>Drag & Drop / Click to upload</p>
                                </div>
                                <div class="file-tags">
                                    <div class="file-tag">CSV</div>
                                    <div class="file-tag outline">&lt; 50 MB</div>
                                </div>
                            </div>
                        </div>

                        <div class="upload-progress" id="uploadProgress">
                            <div class="progress-card">
                                <div class="progress-info">
                                    <h3 id="fileName">subject01-surface.csv</h3>
                                    <p>
                                        <span class="blue-text" id="progressPercent">0</span>
                                        <span class="blue-text">% Uploading</span>
                                        <span class="gray-text"> Â· </span>
                                        <span class="blue-text" id="fileSize">0 MB</span>
                                    </p>
                                </div>
                                <div class="progress-controls">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill"></div>
                                    </div>
                                    <button class="remove-btn" id="removeBtn">
                                        <svg
                                            width="8"
                                            height="8"
                                            viewBox="0 0 10 11"
                                            fill="none"
                                            xmlns="http://www.w3.org/2000/svg"
                                        >
                                            <path
                                                d="M8.99915 9.5L1 1.5M1.00085 9.5L9 1.5"
                                                stroke="#141B34"
                                                stroke-width="1.5"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            />
                                        </svg>
                                    </button>
                                    <button class="sync-btn" id="syncBtn">Sync Now</button>
                                    <div class="loader hidden" id="loader"></div>
                                </div>
                            </div>
                        </div>

                        <div class="charts-section">
                            <div class="chart-container">
                                <div class="chart-area">
                                    <div class="file-visualization" id="fileVisualization">
                                        <div id="visualizationPlaceholder">
                                            Upload a file to see data visualization
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-footer">
                                    <div class="chart-controls">
                                        <button class="chart-title-btn">
                                            Before Synchronization
                                        </button>
                                        <div class="chart-badges"></div>
                                    </div>
                                </div>
                                <div id="uPlotChartOne"></div>
                            </div>

                            <div class="chart-container">
                                <div class="chart-area">
                                    <div
                                        class="file-visualization empty-chart"
                                        id="synchronizedChartContainer"
                                    >
                                        Synchronized data will appear here
                                    </div>
                                </div>
                                <div class="chart-footer">
                                    <div class="chart-controls">
                                        <button class="chart-title-btn">
                                            After Synchronization
                                        </button>
                                    </div>
                                    <button class="download-btn disabled" id="downloadBtn">
                                        Download Synchronized Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
        <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>

        <script>
            // Application state
            let appState = {
                uploadedFiles: [],
                uploadProgress: 0,
                isDragging: false,
                showTooltip1: false,
                showTooltip2: false,
            };

            // DOM elements
            const dropZone = document.getElementById("dropZone");
            const fileInput = document.getElementById("fileInput");
            const uploadProgress = document.getElementById("uploadProgress");
            const fileName = document.getElementById("fileName");
            const progressPercent = document.getElementById("progressPercent");
            const progressFill = document.getElementById("progressFill");
            const fileSize = document.getElementById("fileSize");
            const removeBtn = document.getElementById("removeBtn");
            const syncBtn = document.getElementById("syncBtn");
            const downloadBtn = document.getElementById("downloadBtn");
            const tooltips = document.querySelectorAll(".chart-tooltip");
            const loader = document.getElementById("loader");
            const mainContent = document.getElementById("mainContent");
            const placeholderContent = document.getElementById("placeholderContent");
            const fileVisualization = document.getElementById("fileVisualization");
            const synchronizedChartContainer = document.getElementById(
                "synchronizedChartContainer"
            );

            let synchronizedDataBlob = null;
            let synchronizedCharts = [];
            let chartInstances = [];
            
            const columns = { time: "time", x: "x", y: "y", z: "z" };

            function getUPlotConfig(chartData, title, columns, parentWidth, parentHeight) {
                const time = chartData.map((d) => d.time);
                const x = chartData.map((d) => d.x);
                const y = chartData.map((d) => d.y);
                const z = chartData.map((d) => d.z);

                const uPlotdata = [time, x, y, z];

                const uPlotOpts = {
                title: title,
                width: parentWidth,
                height: parentHeight,
                scales: {
                    x: { time: false },
                    y: { auto: true },
                },
                axes: [
                    { label: columns.time === "index" ? "Sample" : columns.time },
                    { label: "Acceleration" },
                ],
                series: [
                    { label: "index", stroke: "#853e1a", width: 2},
                    { label: "X-axis", stroke: "#EF4444", width: 2 },
                    { label: "Y-axis", stroke: "#10B981", width: 2 },
                    { label: "Z-axis", stroke: "#3B82F6", width: 2 },
                ],
                select: {
                    show: false,
                },
                };

                return { uPlotOpts, uPlotdata };
            }

            function findClosest(arr, val) {
                let low = 0;
                let high = arr.length - 1;

                while (low < high) {
                    let mid = Math.floor((low + high) / 2);
                    if (arr[mid] === val) return arr[mid];
                    else if (arr[mid] < val) low = mid + 1;
                    else high = mid;
                }

                if (low === 0) return arr[0];
                if (low === arr.length) return arr[arr.length - 1];

                const prev = arr[low - 1];
                const curr = arr[low];
                return (Math.abs(prev - val) < Math.abs(curr - val)) ? prev : curr;
            }


            async function handleMultipleFiles(files) {
                appState.uploadedFiles = files;
                appState.uploadProgress = 0;

                uploadProgress.classList.add("visible");
                fileName.textContent = files.map((f) => f.name).join(", ");
                fileSize.textContent = files
                .map((f) => formatFileSize(f.size))
                .join(" + ");

                syncBtn.classList.add("disabled");
                downloadBtn.classList.add("disabled");

                progressPercent.textContent = 0;
                progressFill.style.width = "0%";
                let progress = 0;
                const interval = setInterval(() => {
                progress += 10;
                progressPercent.textContent = progress;
                progressFill.style.width = progress + "%";
                if (progress >= 100) {
                    clearInterval(interval);
                    syncBtn.classList.remove("disabled");
                }
                }, 200);

                chartInstances.forEach((chart) => chart.destroy());
                chartInstances = [];
                synchronizedCharts.forEach((chart) => chart.destroy());
                synchronizedCharts = [];
                synchronizedChartContainer.innerHTML =
                "Synchronized data will appear here";
                synchronizedChartContainer.classList.add("empty-chart");

                fileVisualization.innerHTML = "";
                for (let i = 0; i < files.length; i++) {
                try {
                    let data;
                    if (files[i].name.endsWith(".csv")) {
                        data = await parseCSV(files[i]);
                    }
                    else {
                        throw new Error("Unsupported file format");
                    }
                    const columns = detectAccelerometerColumns(data);

                    chartData = data
                    .map((row, index) => ({
                        // time: columns.time === "index" ? index : row[columns.time],
                        time: index,
                        x: parseFloat(row[columns.x]),
                        y: parseFloat(row[columns.y]),
                        z: parseFloat(row[columns.z]),
                    }))
                    .filter(
                        (row, index) =>
                        !isNaN(row.x) && !isNaN(row.y) && !isNaN(row.z)
                    );
                    const width = fileVisualization.clientWidth;
                    const height = fileVisualization.clientHeight;
                    const { uPlotOpts: opts1, uPlotdata: data1 } = getUPlotConfig(chartData, `${files[i].name}`, columns, width, height);
                    const fileVisualizationUPlot = new uPlot(opts1,data1,document.getElementById("fileVisualization"));
                    fileVisualizationUPlot.root.addEventListener("wheel",
                        function (e) {
                            e.preventDefault();

                            const zoomFactor = 0.1;
                            const rect =
                            fileVisualizationUPlot.over.getBoundingClientRect();
                            const mouseX = e.clientX - rect.left;
                            const centerVal = fileVisualizationUPlot.posToVal(mouseX, "x");

                            let min = fileVisualizationUPlot.scales.x.min;
                            let max = fileVisualizationUPlot.scales.x.max;
                            let range = max - min;

                            let newRange;
                            if (e.deltaY < 0) {
                                newRange = range * (1 - zoomFactor);
                            } else {
                                newRange = range * (1 + zoomFactor);
                            }

                            const minRange = 10; 
                            if (newRange < minRange) newRange = minRange;
                            min = centerVal - ((centerVal - min) / range) * newRange;
                            max = min + newRange;

                            const originalMin = fileVisualizationUPlot.data[0][0]; 
                            const originalMax =
                            fileVisualizationUPlot.data[0][
                                fileVisualizationUPlot.data[0].length - 1
                            ];

                            if (min < originalMin) {
                            mix = min + newRange;
                            }
                            if (max > originalMax) {
                            man = max - newRange;
                            }
                            const xData = fileVisualizationUPlot.data[0];
                            min = findClosest(xData, min);
                            max = findClosest(xData, max);

                            fileVisualizationUPlot.setScale("x", { min, max });
                        },
                        { passive: false }
                    );
                    let isDragging = false;
                    let dragStartX = 0;
                    let dragStartMin, dragStartMax;

                    const root = fileVisualizationUPlot.root;

                    root.addEventListener("mousedown", (e) => {
                        e.preventDefault();
                        isDragging = true;
                        dragStartX = e.clientX;
                        dragStartMin = fileVisualizationUPlot.scales.x.min;
                        dragStartMax = fileVisualizationUPlot.scales.x.max;
                    });

                    root.addEventListener("mouseup", (e) => {
                        isDragging = false;
                    });

                    root.addEventListener("mouseleave", (e) => {
                        isDragging = false;
                    });

                    root.addEventListener("mousemove", (e) => {
                        if (!isDragging) return;

                        e.preventDefault();

                        const deltaX = e.clientX - dragStartX;
                        const rect = fileVisualizationUPlot.over.getBoundingClientRect();

                        const pxToVal = (val) => {
                            return fileVisualizationUPlot.posToVal(val, "x");
                        };

                        const dataStart = pxToVal(0);
                        const dataEnd = pxToVal(deltaX);

                        let newMin = dragStartMin - (dataEnd - dataStart);
                        let newMax = dragStartMax - (dataEnd - dataStart);

                        const originalMin = fileVisualizationUPlot.data[0][0];
                        const originalMax =
                            fileVisualizationUPlot.data[0][
                            fileVisualizationUPlot.data[0].length - 1
                            ];

                        const range = newMax - newMin;

                        if (newMin < originalMin) {
                            newMin = originalMin;
                            newMax = newMin + range;
                        }
                        if (newMax > originalMax) {
                            newMax = originalMax;
                            newMin = newMax - range;
                        }

                        fileVisualizationUPlot.setScale("x", {
                            min: newMin,
                            max: newMax,
                        });
                    });
                } catch (error) {
                    console.log(error)
                }
                }
            }

            dropZone.addEventListener("click", (e) => {
                if (e.target !== fileInput) {
                fileInput.click();
                }
            });

            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("dragging");
                appState.isDragging = true;
            });

            dropZone.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dropZone.classList.remove("dragging");
                appState.isDragging = false;
            });

            dropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.classList.remove("dragging");
                appState.isDragging = false;

                const files = Array.from(e.dataTransfer.files).filter(
                (file) =>
                    file.type === "text/csv" ||
                    file.name.endsWith(".csv") 
                );
                if (files.length !== 2) {
                    alert("Please upload exactly 2 CSV files.");
                    return;
                }
                handleMultipleFiles(files);
            });

            fileInput.addEventListener("change", (e) => {
                const files = Array.from(e.target.files).filter(
                (file) =>
                    file.type === "text/csv" ||
                    file.name.endsWith(".csv")
                );
                if (files.length !== 2) {
                    alert("Please select exactly 2 CSV files.");
                    fileInput.value = "";
                    return;
                }
                handleMultipleFiles(files);
            });

            fileInput.addEventListener("click", (e) => {
                e.stopPropagation();
            });

            function formatFileSize(bytes) {
                if (bytes === 0) return "0 B";

                const k = 1024;
                const sizes = ["B", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
            }

            removeBtn.addEventListener("click", () => {
                appState.uploadedFiles = [];
                appState.uploadProgress = 0;
                uploadProgress.classList.remove("visible");
                fileInput.value = "";
                progressFill.style.width = "0%";
                fileSize.textContent = "0 MB";
                updateFileVisualization(null);
                syncBtn.classList.add("disabled");
                downloadBtn.classList.add("disabled");
                loader.classList.add("hidden");
                synchronizedDataBlob = null;
                chartInstances.forEach((chart) => chart.destroy());
                chartInstances = [];
                synchronizedCharts.forEach((chart) => chart.destroy());
                synchronizedCharts = [];
                synchronizedChartContainer.innerHTML =
                "Synchronized data will appear here";
                synchronizedChartContainer.classList.add("empty-chart");
            });

            syncBtn.addEventListener("click", async () => {
                if (appState.uploadedFiles.length < 2) {
                    alert("Please upload two files first.");
                    return;
                }

                syncBtn.classList.add("hidden");
                downloadBtn.classList.add("disabled");
                loader.classList.remove("hidden");

                const formData = new FormData();
                appState.uploadedFiles.forEach((file, index) => {
                formData.append(`file${index + 1}`, file);
                });

                try {
                    const response = await axios.post(
                        API_BASE_URL + "syncFiles",
                        formData,
                        {
                            responseType: "blob",
                            onUploadProgress: (progressEvent) => {
                                const percentCompleted = Math.round(
                                (progressEvent.loaded * 100) / progressEvent.total
                                );
                            },
                        }
                    );

                    synchronizedDataBlob = new Blob([response.data], {
                        type: "application/zip",
                    });
                    downloadBtn.classList.remove("disabled");
                    syncBtn.classList.remove("hidden");
                    syncBtn.textContent = "Resync";

                    await renderSynchronizedCharts(synchronizedDataBlob);
                } catch (error) {
                    console.error("Synchronization failed:", error);
                    alert(
                        "Synchronization failed. Please check the server and try again."
                    );
                    syncBtn.classList.remove("hidden");
                    syncBtn.textContent = "Sync Now";
                } finally {
                    loader.classList.add("hidden");
                }
            });

            downloadBtn.addEventListener("click", () => {
                if (synchronizedDataBlob) {
                    const url = window.URL.createObjectURL(synchronizedDataBlob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.setAttribute("download", "synchronized_data.zip");
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert("No synchronized data available to download.");
                }
            });

            function parseCSV(file) {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                        resolve(results.data);
                        },
                        error: function (error) {
                        reject(error);
                        },
                    });
                });
            }

            function detectAccelerometerColumns(data) {
                if (!data || data.length === 0) return null;

                const firstRow = data[0];
                const columns = Object.keys(firstRow);

                const [x, y, z] = columns;
                return {x,y,z}
            }

            async function updateFileVisualization(file) {
                const fileVisualization = document.getElementById("fileVisualization");

                if (!file) {
                    fileVisualization.innerHTML = `<div id="visualizationPlaceholder">Upload a file to see data visualization</div>`;
                    return;
                }

                fileVisualization.innerHTML = `
                    <div id="visualizationPlaceholder">
                    <div style="margin-bottom: 1rem;">
                    <div style="width: 32px; height: 32px; border: 3px solid #E2E8F0; border-top: 3px solid #3276E8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Parsing ${file.name}</div>
                    <div style="font-size: 12px; opacity: 0.7;">Processing data...</div>
                    </div>
                `;

                
            }

            async function renderSynchronizedCharts(zipBlob) {
                synchronizedChartContainer.innerHTML = `
                    <div id="visualizationPlaceholder">
                    <div style="margin-bottom: 1rem;">
                    <div style="width: 32px; height: 32px; border: 3px solid #E2E8F0; border-top: 3px solid #3276E8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Unzipping synchronized data...</div>
                    </div>
                    `;

                try {
                    const zip = new JSZip();
                    const unzipped = await zip.loadAsync(zipBlob);

                    synchronizedChartContainer.classList.remove("empty-chart");
                    synchronizedChartContainer.innerHTML = "";
                    synchronizedChartContainer.style.display = "flex";
                    synchronizedChartContainer.style.flexDirection = "column";
                    synchronizedChartContainer.style.gap = "2rem";
                    synchronizedChartContainer.style.height = "100%";
                    synchronizedChartContainer.style.overflowY = "auto";

                    const fileEntries = Object.keys(unzipped.files).filter(
                        (filename) => !unzipped.files[filename].dir
                    );

                    for (let i = 0; i < fileEntries.length; i++) {
                        const filename = fileEntries[i];
                        const fileContent = await unzipped.files[filename].async("blob");
                        const file = new File([fileContent], filename);

                        let data;
                        if (filename.endsWith(".csv")) {
                            data = await parseCSV(file);
                        }
                        
                        const columns = detectAccelerometerColumns(data);

                        chartData = data
                        .map((row, index) => ({
                            time: index,
                            x: parseFloat(row[columns.x]),
                            y: parseFloat(row[columns.y]),
                            z: parseFloat(row[columns.z]),
                        }))
                        .filter(
                            (row, index) =>
                            !isNaN(row.x) && !isNaN(row.y) && !isNaN(row.z)
                        );
                        
                        const width = synchronizedChartContainer.clientWidth;
                        const height = synchronizedChartContainer.clientHeight;

                        const { uPlotOpts: opts1, uPlotdata: data1 } = getUPlotConfig(chartData,`Synchronized Data - ${filename}`,columns, width, height);
                        const synchronizedChartContainerUPlot = new uPlot(opts1,data1,document.getElementById("synchronizedChartContainer"));
                        synchronizedChartContainerUPlot.root.addEventListener(
                            "wheel",
                            function (e) {
                                e.preventDefault();

                                const zoomFactor = 0.1;
                                const rect =
                                synchronizedChartContainerUPlot.over.getBoundingClientRect();
                                const mouseX = e.clientX - rect.left;
                                const centerVal = synchronizedChartContainerUPlot.posToVal(mouseX,"x");

                                let min = synchronizedChartContainerUPlot.scales.x.min;
                                let max = synchronizedChartContainerUPlot.scales.x.max;
                                let range = max - min;

                                let newRange;
                                if (e.deltaY < 0) {
                                    newRange = range * (1 - zoomFactor);
                                } else {
                                    newRange = range * (1 + zoomFactor);
                                }

                                const minRange = 10; 
                                if (newRange < minRange) newRange = minRange;

                                min = centerVal - ((centerVal - min) / range) * newRange;
                                max = min + newRange;

                                const originalMin = synchronizedChartContainerUPlot.data[0][0];
                                const originalMax =
                                synchronizedChartContainerUPlot.data[0][
                                    synchronizedChartContainerUPlot.data[0].length - 1
                                ]; 

                                if (min < originalMin) {
                                    min = originalMin;
                                    max = min + newRange;
                                }
                                if (max > originalMax) {
                                    max = originalMax;
                                    min = max - newRange;
                                }
                                const xData = synchronizedChartContainerUPlot.data[0];
                                min = findClosest(xData, min);
                                max = findClosest(xData, max);

                                synchronizedChartContainerUPlot.setScale("x", { min, max });
                            },
                            { passive: false }
                        );
                        let isDragging = false;
                        let dragStartX = 0;
                        let dragStartMin, dragStartMax;

                        const root = synchronizedChartContainerUPlot.root;

                        root.addEventListener("mousedown", (e) => {
                            e.preventDefault();
                            isDragging = true;
                            dragStartX = e.clientX;

                            dragStartMin = synchronizedChartContainerUPlot.scales.x.min;
                            dragStartMax = synchronizedChartContainerUPlot.scales.x.max;
                        });

                        root.addEventListener("mouseup", (e) => {
                            isDragging = false;
                        });

                        root.addEventListener("mouseleave", (e) => {
                            isDragging = false;
                        });

                        root.addEventListener("mousemove", (e) => {
                            if (!isDragging) return;

                            e.preventDefault();

                            const deltaX = e.clientX - dragStartX;
                            const rect =
                                synchronizedChartContainerUPlot.over.getBoundingClientRect();

                            const pxToVal = (val) => {
                                return synchronizedChartContainerUPlot.posToVal(val, "x");
                            };

                            const dataStart = pxToVal(0);
                            const dataEnd = pxToVal(deltaX);

                            let newMin = dragStartMin - (dataEnd - dataStart);
                            let newMax = dragStartMax - (dataEnd - dataStart);

                            const originalMin = synchronizedChartContainerUPlot.data[0][0];
                            const originalMax =
                                synchronizedChartContainerUPlot.data[0][
                                synchronizedChartContainerUPlot.data[0].length - 1
                                ];

                            const range = newMax - newMin;

                            if (newMin < originalMin) {
                                newMin = originalMin;
                                newMax = newMin + range;
                            }
                            if (newMax > originalMax) {
                                newMax = originalMax;
                                newMin = newMax - range;
                            }
                            synchronizedChartContainerUPlot.setScale("x", {
                                min: newMin,
                                max: newMax,
                            });
                        });
                    }
                } catch (error) {
                    console.error(
                        "Error unzipping or plotting synchronized data:",
                        error
                    );
                    synchronizedChartContainer.innerHTML = `
                        <div id="visualizationPlaceholder" style="padding: 2rem;">
                        <div style="color: #EF4444; margin-bottom: 1rem;">â</div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Error processing synchronized data</div>
                        <div style="font-size: 12px; opacity: 0.7;">${error.message}</div>
                        </div>
                        `;
                    synchronizedChartContainer.classList.add("empty-chart");
                }
            }
        </script>
    </body>
</html>
